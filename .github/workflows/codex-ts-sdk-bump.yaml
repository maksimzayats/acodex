name: Bump Codex TS SDK

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    if: github.repository == 'maksimzayats/acodex'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --group dev --group docs

      - name: Read current release tag
        id: current
        run: |
          tag="$(uv run python -c 'import json; from pathlib import Path; print(json.loads(Path("vendor/codex-ts-sdk/UPSTREAM.json").read_text(encoding="utf-8"))["release_tag"])')"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Fetch latest stable release tag
        id: latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="$(uv run python tools/vendor/latest_codex_release.py --field release_tag)"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Stop if already up-to-date
        if: steps.current.outputs.tag == steps.latest.outputs.tag
        run: |
          echo "Already pinned to ${{ steps.current.outputs.tag }}; no stable release bump needed."

      - name: Vendor latest release
        if: steps.current.outputs.tag != steps.latest.outputs.tag
        run: make vendor-ts-sdk TAG="${{ steps.latest.outputs.tag }}"

      - name: Read new commit
        if: steps.current.outputs.tag != steps.latest.outputs.tag
        id: meta
        run: |
          commit="$(uv run python -c 'import json; from pathlib import Path; print(json.loads(Path("vendor/codex-ts-sdk/UPSTREAM.json").read_text(encoding="utf-8"))["commit"])')"
          echo "commit=$commit" >> "$GITHUB_OUTPUT"

      - name: Open PR
        if: steps.current.outputs.tag != steps.latest.outputs.tag
        uses: peter-evans/create-pull-request@v7
        with:
          branch: codex/bump-ts-sdk
          delete-branch: true
          title: Bump Codex TS SDK to ${{ steps.latest.outputs.tag }}
          body: |
            Bumps vendored Codex TypeScript SDK:

            - Old: `${{ steps.current.outputs.tag }}`
            - New: `${{ steps.latest.outputs.tag }}`
            - Commit: `${{ steps.meta.outputs.commit }}`

            This PR is generated by the hourly release checker workflow and only tracks stable GitHub Releases.
          commit-message: Bump Codex TS SDK to ${{ steps.latest.outputs.tag }}
